name: android14-avd-scrcpy-browser

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Duration in hours'
        required: true
        default: '6'

jobs:
  android-emulator:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - uses: actions/checkout@v4

      - name: Install Packages
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            wget unzip curl net-tools \
            xvfb x11vnc dbus-x11 \
            libpulse0 libasound2 libglib2.0-0 \
            libxext6 libxrender1 libx11-6 \
            libfreetype6 libfontconfig1 \
            libgl1-mesa-glx libxkbcommon0 \
            libtinfo6 libncurses6 libc6 libstdc++6 \
            libxcb1 libxcb-render0 libxcb-shape0 \
            libxkbfile1 libxext-dev libxrender-dev \
            vulkan-tools libvulkan1 \
            scrcpy adb ffmpeg
          
          echo "âœ… All packages installed (including scrcpy)"

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules > /dev/null
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          sudo chmod 666 /dev/kvm
          sudo usermod -a -G kvm runner
          echo "âœ… KVM enabled"

      - name: Setup /mnt Storage
        run: |
          sudo mkdir -p /mnt/android-sdk /mnt/android-avd
          sudo chown -R $(whoami):$(whoami) /mnt/android-sdk /mnt/android-avd
          chmod -R 755 /mnt/android-sdk /mnt/android-avd
          df -h /mnt
          echo "âœ… /mnt ready"

      - name: Set Environment
        run: |
          cat >> $GITHUB_ENV << 'EOF'
          ANDROID_SDK_ROOT=/mnt/android-sdk
          ANDROID_HOME=/mnt/android-sdk
          ANDROID_AVD_HOME=/mnt/android-avd
          PATH=/mnt/android-sdk/cmdline-tools/latest/bin:/mnt/android-sdk/emulator:/mnt/android-sdk/platform-tools:/usr/bin:/bin
          LD_LIBRARY_PATH=/mnt/android-sdk/emulator/lib64:$LD_LIBRARY_PATH
          LIBGL_ALWAYS_INDIRECT=1
          EOF
          echo "âœ… Environment set"

      - name: Install Android SDK
        run: |
          echo "ğŸ“¥ Downloading SDK..."
          cd /mnt/android-sdk
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          mkdir -p temp_extract
          cd temp_extract
          unzip -q ../commandlinetools-linux-11076708_latest.zip
          cd /mnt/android-sdk
          mkdir -p cmdline-tools/latest
          mv temp_extract/cmdline-tools/* cmdline-tools/latest/
          rm -rf temp_extract
          rm commandlinetools-linux-11076708_latest.zip
          echo "âœ… SDK tools installed"

      - name: Accept Licenses
        run: |
          yes | /mnt/android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null 2>&1 || true
          echo "âœ… Licenses accepted"

      - name: Install Android 14
        run: |
          echo "ğŸ“¥ Installing Android 14..."
          /mnt/android-sdk/cmdline-tools/latest/bin/sdkmanager \
            "platform-tools" \
            "platforms;android-34" \
            "build-tools;34.0.0" \
            "emulator" \
            "system-images;android-34;default;x86_64"
          echo "âœ… Android 14 installed"

      - name: Create AVD (12GB RAM, 40GB Storage)
        run: |
          echo "ğŸ”§ Creating AVD..."
          echo "no" | /mnt/android-sdk/cmdline-tools/latest/bin/avdmanager create avd \
            --force \
            --name "android14" \
            --package "system-images;android-34;default;x86_64" \
            --device "pixel_7"
          
          AVD_INI="/mnt/android-avd/android14.avd/config.ini"
          sed -i '/^hw.ramSize=/d' "$AVD_INI"
          sed -i '/^disk.dataPartition.size=/d' "$AVD_INI"
          sed -i '/^hw.gpu/d' "$AVD_INI"
          sed -i '/^hw.audio/d' "$AVD_INI"
          
          cat >> "$AVD_INI" << 'EOF'
          hw.ramSize=12288
          disk.dataPartition.size=40G
          hw.gpu.enabled=yes
          hw.gpu.mode=swiftshader_indirect
          hw.keyboard=yes
          hw.mainKeys=no
          hw.audio=none
          EOF
          
          echo "âœ… AVD created"

      - name: Start Virtual Display
        run: |
          Xvfb :1 -screen 0 1920x1080x24 > /tmp/xvfb.log 2>&1 &
          sleep 3
          export DISPLAY=:1
          echo "DISPLAY=:1" >> $GITHUB_ENV
          echo "âœ… Display started"

      - name: Start Emulator
        run: |
          export DISPLAY=:1
          export ANDROID_SDK_ROOT=/mnt/android-sdk
          export ANDROID_AVD_HOME=/mnt/android-avd
          export LD_LIBRARY_PATH=/mnt/android-sdk/emulator/lib64:$LD_LIBRARY_PATH
          
          echo "ğŸš€ Starting emulator..."
          /mnt/android-sdk/emulator/emulator \
            -avd android14 \
            -no-snapshot-load \
            -no-boot-anim \
            -gpu swiftshader_indirect \
            -no-audio \
            -memory 12288 \
            -partition-size 40960 \
            -cores 4 \
            > /tmp/emulator.log 2>&1 &
          
          sleep 15
          
          echo "â³ Waiting for device..."
          for i in {1..40}; do
            if /mnt/android-sdk/platform-tools/adb devices 2>/dev/null | grep -q "emulator"; then
              echo "âœ… Device found!"
              break
            fi
            sleep 5
          done
          
          echo "â³ Waiting for boot..."
          for i in {1..60}; do
            BOOT=$(/mnt/android-sdk/platform-tools/adb shell "getprop sys.boot_completed" 2>/dev/null)
            if [ "$BOOT" = "1" ]; then
              echo "âœ… Boot complete!"
              break
            fi
            sleep 5
          done
          
          echo ""
          /mnt/android-sdk/platform-tools/adb devices
          echo "âœ… Ready!"

      - name: Start Scrcpy Stream
        run: |
          export DISPLAY=:1
          
          echo "ğŸ“± Starting scrcpy stream..."
          
          # Start scrcpy in TCP server mode (listens on port 8888)
          nohup scrcpy --tcpip=127.0.0.1 --port 8888 > /tmp/scrcpy.log 2>&1 &
          
          sleep 5
          echo "âœ… Scrcpy streaming on port 8888"

      - name: Setup FRP Tunnel
        run: |
          cd /tmp
          wget -q https://github.com/fatedier/frp/releases/download/v0.65.0/frp_0.65.0_linux_amd64.tar.gz
          tar -xzf frp_0.65.0_linux_amd64.tar.gz
          
          # Expose both VNC (5900) and Scrcpy (8888)
          cat > frpc.toml << 'EOF'
          serverAddr = "159.195.6.61"
          serverPort = 7000
          
          [[proxies]]
          name = "vnc-avd"
          type = "tcp"
          localIP = "127.0.0.1"
          localPort = 5900
          remotePort = 5900
          
          [[proxies]]
          name = "scrcpy-stream"
          type = "tcp"
          localIP = "127.0.0.1"
          localPort = 8888
          remotePort = 8888
          EOF
          
          nohup ./frp_0.65.0_linux_amd64/frpc -c frpc.toml > /tmp/frpc.log 2>&1 &
          sleep 3
          echo "âœ… FRP tunnel ready (VNC:5900 + Scrcpy:8888)"

      - name: Setup tmate SSH
        uses: mxschmitt/action-tmate@v3
        with:
          detached: true
          limit-access-to-actor: false
        timeout-minutes: 5

      - name: Connection Info
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     âœ… ANDROID 14 AVD - ugPhone-like Experience!    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“± ACCESS METHODS"
          echo ""
          echo "1ï¸âƒ£  SCRCPY (Recommended - Like ugPhone)"
          echo "   Install Scrcpy on your PC:"
          echo "   â€¢ Windows: choco install scrcpy"
          echo "   â€¢ Mac: brew install scrcpy"
          echo "   â€¢ Linux: sudo apt install scrcpy"
          echo ""
          echo "   Then connect:"
          echo "   scrcpy --tcpip=159.195.6.61 --port 8888"
          echo ""
          echo "   Features:"
          echo "   âœ“ Full touch support (like real phone)"
          echo "   âœ“ Drag & drop files"
          echo "   âœ“ Copy-paste between PC and AVD"
          echo "   âœ“ Keyboard input"
          echo "   âœ“ Fullscreen mode"
          echo "   âœ“ Best latency"
          echo ""
          echo "2ï¸âƒ£  BROWSER (via VPS)"
          echo "   Install on VPS (159.195.6.61):"
          echo "   sudo apt install novnc websockify"
          echo "   mkdir -p ~/novnc && cd ~/novnc"
          echo "   git clone https://github.com/novnc/noVNC.git"
          echo "   nohup ~/noVNC/utils/websockify 6080 localhost:5900 --web ~/noVNC &"
          echo ""
          echo "   Then access: http://159.195.6.61:6080/vnc.html"
          echo ""
          echo "3ï¸âƒ£  SSH TERMINAL (Rooting, ADB commands)"
          echo "   See tmate connection in logs above"
          echo ""
          echo "ğŸ’¾ DEVICE SPECS"
          echo "   â€¢ Android: 14 (API 34)"
          echo "   â€¢ Type: AOSP (No Play Store)"
          echo "   â€¢ RAM: 12GB"
          echo "   â€¢ Storage: 40GB"
          echo "   â€¢ Device: Pixel 7"
          echo ""
          echo "â±ï¸  DURATION: ${{ github.event.inputs.duration || '6' }} hours"
          echo ""
          echo "ğŸ”§ ROOT WITH rootAVD (via SSH):"
          echo "   export DISPLAY=:1"
          echo "   cd /tmp && git clone https://github.com/newbit1/rootAVD.git"
          echo "   cd rootAVD && chmod +x rootAVD.sh && ./rootAVD.sh"
          echo "   adb reboot"
          echo ""

      - name: Keep Alive
        run: |
          HOURS=${{ github.event.inputs.duration || '6' }}
          MINUTES=$((HOURS * 60))
          
          echo "ğŸ”„ Running for $HOURS hours..."
          
          for ((i=0; i<MINUTES; i++)); do
            sleep 60
            
            if [ $((i % 10)) -eq 0 ]; then
              STATE=$(/mnt/android-sdk/platform-tools/adb get-state 2>/dev/null || echo "offline")
              echo "[$i min] State: $STATE"
            fi
            
            if ! /mnt/android-sdk/platform-tools/adb get-state > /dev/null 2>&1; then
              echo "âš ï¸  Restarting at $i min"
              export DISPLAY=:1
              export LD_LIBRARY_PATH=/mnt/android-sdk/emulator/lib64:$LD_LIBRARY_PATH
              /mnt/android-sdk/emulator/emulator \
                -avd android14 \
                -no-snapshot-load \
                -gpu swiftshader_indirect \
                -memory 12288 \
                -partition-size 40960 \
                > /tmp/emulator.log 2>&1 &
              sleep 60
            fi
          done

      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: avd-logs
          path: /tmp/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          killall -9 emulator x11vnc Xvfb frpc scrcpy 2>/dev/null || true
          echo "âœ… Done"
