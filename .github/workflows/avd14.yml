name: android14-avd-vnc

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Duration in hours'
        required: true
        default: '6'

jobs:
  android-emulator:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Required Packages
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y wget unzip curl
          echo "‚úÖ Base packages installed"

      - name: Check Storage
        run: |
          echo "üìä Storage Check:"
          echo "Root (/):"
          df -h / | tail -1
          echo "Mount (/mnt):"
          df -h /mnt | tail -1
          echo ""
          echo "Total: 146GB available"

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules > /dev/null
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          sudo chmod 666 /dev/kvm
          sudo usermod -a -G kvm runner
          ls -la /dev/kvm
          echo "‚úÖ KVM enabled"

      - name: Setup /mnt for AVD Storage
        run: |
          sudo mkdir -p /mnt/android-sdk
          sudo mkdir -p /mnt/android-avd
          sudo mkdir -p /mnt/avd-data
          sudo chown -R $(whoami):$(whoami) /mnt/android-sdk /mnt/android-avd /mnt/avd-data
          chmod -R 755 /mnt/android-sdk /mnt/android-avd /mnt/avd-data
          echo "‚úÖ /mnt directories created (74GB available)"

      - name: Setup Android Environment Variables
        run: |
          cat >> $GITHUB_ENV << 'EOF'
          ANDROID_SDK_ROOT=/mnt/android-sdk
          ANDROID_HOME=/mnt/android-sdk
          ANDROID_AVD_HOME=/mnt/android-avd
          ANDROID_EMULATOR_HOME=/mnt/android-avd
          ANDROID_PREFS_ROOT=/mnt/android-sdk/.android
          PATH=/mnt/android-sdk/cmdline-tools/latest/bin:/mnt/android-sdk/emulator:/mnt/android-sdk/platform-tools:$PATH
          EOF
          
          echo "export ANDROID_SDK_ROOT=/mnt/android-sdk" >> ~/.bashrc
          echo "export ANDROID_HOME=/mnt/android-sdk" >> ~/.bashrc
          echo "export ANDROID_AVD_HOME=/mnt/android-avd" >> ~/.bashrc
          echo "export ANDROID_EMULATOR_HOME=/mnt/android-avd" >> ~/.bashrc
          echo "export PATH=/mnt/android-sdk/cmdline-tools/latest/bin:/mnt/android-sdk/emulator:/mnt/android-sdk/platform-tools:$PATH" >> ~/.bashrc
          
          echo "‚úÖ Android environment variables set"

      - name: Install Android SDK Command-line Tools
        run: |
          cd /mnt/android-sdk
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip -q commandlinetools-linux-11076708_latest.zip
          mkdir -p cmdline-tools/latest
          mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
          rm commandlinetools-linux-11076708_latest.zip
          
          echo "‚úÖ SDK command-line tools installed"

      - name: Accept SDK Licenses
        run: |
          yes | /mnt/android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null 2>&1 || true
          echo "‚úÖ SDK licenses accepted"

      - name: Install Android 14 System Image (No Play Store)
        run: |
          echo "üì• Installing Android 14 AOSP system image..."
          /mnt/android-sdk/cmdline-tools/latest/bin/sdkmanager \
            "platform-tools" \
            "platforms;android-34" \
            "build-tools;34.0.0" \
            "emulator" \
            "system-images;android-34;default;x86_64"
          
          echo "‚úÖ Android 14 (AOSP, no Play Store) installed"
          echo ""
          echo "üì¶ Installed packages:"
          /mnt/android-sdk/cmdline-tools/latest/bin/sdkmanager --list_installed

      - name: Create AVD with 12GB RAM and 40GB Storage
        run: |
          echo "üîß Creating Android 14 AVD..."
          
          echo "no" | /mnt/android-sdk/cmdline-tools/latest/bin/avdmanager create avd \
            --force \
            --name "android14_custom" \
            --package "system-images;android-34;default;x86_64" \
            --device "pixel_7"
          
          AVD_CONFIG="/mnt/android-avd/android14_custom.avd/config.ini"
          
          # Set 12GB RAM
          sed -i 's/hw.ramSize=.*/hw.ramSize=12288/' "$AVD_CONFIG"
          sed -i 's/vm.heapSize=.*/vm.heapSize=512/' "$AVD_CONFIG"
          
          # Set 40GB storage
          echo "disk.dataPartition.size=40G" >> "$AVD_CONFIG"
          
          # GPU and hardware acceleration
          echo "hw.gpu.enabled=yes" >> "$AVD_CONFIG"
          echo "hw.gpu.mode=swiftshader_indirect" >> "$AVD_CONFIG"
          echo "hw.keyboard=yes" >> "$AVD_CONFIG"
          echo "hw.mainKeys=no" >> "$AVD_CONFIG"
          
          echo ""
          echo "‚úÖ AVD Created:"
          echo "  RAM: 12GB"
          echo "  Storage: 40GB"
          echo "  Android: 14 (API 34, AOSP)"

      - name: Install VNC Server & Desktop
        run: |
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            xvfb \
            x11vnc \
            openbox \
            dbus-x11 \
            xterm \
            net-tools
          
          echo "‚úÖ VNC server installed"

      - name: Start Xvfb & X11 Session
        run: |
          Xvfb :99 -screen 0 1920x1080x24 -ac +extension GLX +render -noreset > /tmp/xvfb.log 2>&1 &
          sleep 3
          
          export DISPLAY=:99
          echo "DISPLAY=:99" >> $GITHUB_ENV
          
          openbox --config-file /dev/null > /tmp/openbox.log 2>&1 &
          sleep 2
          
          echo "‚úÖ X11 display started on :99"

      - name: Start VNC Server on Port 5900
        run: |
          export DISPLAY=:99
          x11vnc -display :99 -forever -nopw -rfbport 5900 -shared -bg -xkb
          sleep 2
          
          if netstat -tuln | grep -q ':5900'; then
            echo "‚úÖ VNC server running on port 5900"
          else
            echo "‚ùå VNC server failed to start"
            exit 1
          fi

      - name: Setup FRP Tunnel for VNC
        run: |
          wget -q https://github.com/fatedier/frp/releases/download/v0.65.0/frp_0.65.0_linux_amd64.tar.gz
          tar -xzf frp_0.65.0_linux_amd64.tar.gz
          
          cat > frpc.toml << 'EOF'
          serverAddr = "159.195.6.61"
          serverPort = 7000
          
          [[proxies]]
          name = "vnc-avd"
          type = "tcp"
          localIP = "127.0.0.1"
          localPort = 5900
          remotePort = 5900
          EOF
          
          nohup ./frp_0.65.0_linux_amd64/frpc -c frpc.toml > frpc.log 2>&1 &
          sleep 3
          
          if ps aux | grep -v grep | grep -q frpc; then
            echo "‚úÖ FRP tunnel active: 159.195.6.61:5900"
          else
            echo "‚ö†Ô∏è  FRP may not be connected, check logs"
            cat frpc.log
          fi

      - name: Start Android Emulator
        run: |
          export DISPLAY=:99
          export ANDROID_SDK_ROOT=/mnt/android-sdk
          export ANDROID_AVD_HOME=/mnt/android-avd
          
          echo "üöÄ Starting Android 14 emulator..."
          
          /mnt/android-sdk/emulator/emulator \
            -avd android14_custom \
            -no-snapshot-load \
            -no-boot-anim \
            -gpu swiftshader_indirect \
            -no-audio \
            -camera-back none \
            -camera-front none \
            -memory 12288 \
            -partition-size 40960 \
            -cores 4 \
            -verbose \
            > /tmp/emulator.log 2>&1 &
          
          EMULATOR_PID=$!
          echo "EMULATOR_PID=$EMULATOR_PID" >> $GITHUB_ENV
          echo "Emulator PID: $EMULATOR_PID"
          
          echo "‚è≥ Waiting for emulator to boot (this may take 3-5 minutes)..."
          
          # Wait for ADB to detect device
          timeout 300 bash -c '
          until /mnt/android-sdk/platform-tools/adb devices | grep -q "emulator"; do
            echo "  Waiting for device..."
            sleep 5
          done
          '
          
          # Wait for boot to complete
          timeout 600 bash -c '
          until /mnt/android-sdk/platform-tools/adb shell "getprop sys.boot_completed" 2>/dev/null | grep -q "1"; do
            echo "  Booting..."
            sleep 10
          done
          '
          
          if /mnt/android-sdk/platform-tools/adb shell "getprop sys.boot_completed" 2>/dev/null | grep -q "1"; then
            echo ""
            echo "‚úÖ Emulator fully booted!"
            echo ""
            echo "üì± Device Info:"
            /mnt/android-sdk/platform-tools/adb devices
            /mnt/android-sdk/platform-tools/adb shell getprop ro.build.version.release
            /mnt/android-sdk/platform-tools/adb shell getprop ro.product.model
            /mnt/android-sdk/platform-tools/adb shell df -h /data
          else
            echo "‚ö†Ô∏è  Emulator boot timeout, but continuing..."
            echo "Last 50 lines of emulator log:"
            tail -50 /tmp/emulator.log
          fi

      - name: Setup tmate SSH Session
        uses: mxschmitt/action-tmate@v3
        with:
          detached: true
          limit-access-to-actor: false
        timeout-minutes: 5

      - name: Connection Info & Instructions
        run: |
          echo ""
          echo "=========================================================="
          echo "‚úÖ ANDROID 14 AVD READY WITH VNC + SSH ACCESS!"
          echo "=========================================================="
          echo ""
          echo "üì± AVD Details:"
          echo "  - Android Version: 14 (API 34)"
          echo "  - Type: AOSP (No Play Store)"
          echo "  - RAM: 12GB"
          echo "  - Storage: 40GB (on /mnt)"
          echo "  - Device: Pixel 7"
          echo ""
          echo "üñ•Ô∏è  VNC Access:"
          echo "  - Address: 159.195.6.61:5900"
          echo "  - No password"
          echo ""
          echo "üîê SSH Access:"
          echo "  - Check tmate connection above in logs"
          echo ""
          echo "üìã Useful Commands (via SSH):"
          echo "  adb devices              # Check emulator status"
          echo "  adb reboot               # Restart emulator"
          echo "  adb emu kill             # Stop emulator"
          echo "  adb shell                # Shell into Android"
          echo ""
          echo "  # Start emulator manually:"
          echo "  export DISPLAY=:99"
          echo "  cd /mnt/android-sdk/emulator"
          echo "  ./emulator -avd android14_custom -no-snapshot-load -gpu swiftshader_indirect &"
          echo ""
          echo "  # Root with rootAVD:"
          echo "  cd /mnt/avd-data"
          echo "  git clone https://github.com/newbit1/rootAVD.git"
          echo "  cd rootAVD"
          echo "  ./rootAVD.sh"
          echo ""
          echo "‚è±Ô∏è  Duration: ${{ github.event.inputs.duration || '6' }} hours"
          echo "=========================================================="

      - name: Keep Alive & Monitor
        run: |
          DURATION=${{ github.event.inputs.duration || '6' }}
          SECONDS=$((DURATION * 3600))
          
          echo "üîÑ Monitoring for $DURATION hours..."
          echo ""
          
          for ((i=0; i<$((SECONDS/60)); i++)); do
            sleep 60
            
            # Check statuses
            if /mnt/android-sdk/platform-tools/adb get-state > /dev/null 2>&1; then
              AVD_STATUS="‚úÖ"
            else
              AVD_STATUS="‚ùå"
            fi
            
            if netstat -tuln | grep -q ':5900'; then
              VNC_STATUS="‚úÖ"
            else
              VNC_STATUS="‚ùå"
            fi
            
            if ps aux | grep -v grep | grep -q frpc; then
              FRP_STATUS="‚úÖ"
            else
              FRP_STATUS="‚ùå"
            fi
            
            # Log every 10 minutes
            if [ $((i % 10)) -eq 0 ]; then
              echo "[$((i)) min] AVD:$AVD_STATUS VNC:$VNC_STATUS FRP:$FRP_STATUS"
            fi
            
            # Auto-restart emulator if crashed
            if ! /mnt/android-sdk/platform-tools/adb get-state > /dev/null 2>&1; then
              echo "‚ö†Ô∏è  Emulator stopped at $((i)) min, restarting..."
              export DISPLAY=:99
              /mnt/android-sdk/emulator/emulator -avd android14_custom -no-snapshot-load -gpu swiftshader_indirect -no-audio -partition-size 40960 > /tmp/emulator.log 2>&1 &
              sleep 60
            fi
          done
          
          echo "‚è∞ Session ended after $DURATION hours"

      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: avd-logs
          path: |
            /tmp/xvfb.log
            /tmp/openbox.log
            /tmp/emulator.log
            frpc.log
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          echo "üßπ Cleaning up..."
          /mnt/android-sdk/platform-tools/adb emu kill 2>/dev/null || true
          killall -9 emulator 2>/dev/null || true
          killall -9 x11vnc 2>/dev/null || true
          killall -9 Xvfb 2>/dev/null || true
          killall -9 frpc 2>/dev/null || true
          echo "‚úÖ Cleanup complete"
