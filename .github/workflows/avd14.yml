name: android14-avd-final-working

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Duration in hours'
        required: true
        default: '6'

jobs:
  android-emulator:
    runs-on: ubuntu-latest
    timeout-minutes: 480
    
    steps:
      - uses: actions/checkout@v4

      - name: Install Packages
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y wget unzip curl net-tools git xvfb x11vnc dbus-x11 libxext6 libxrender1 libx11-6 libfreetype6 libfontconfig1 libxkbcommon0 libxkbfile1 libxcb1 libxcb-render0 libxcb-shape0 libc6 libstdc++6 libtinfo6 libncurses6 libasound2t64 mesa-utils libglu1-mesa ffmpeg adb tmate
          echo "โ Packages installed"

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules > /dev/null
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          sudo chmod 666 /dev/kvm
          sudo usermod -a -G kvm runner
          echo "โ KVM enabled"

      - name: Setup /mnt Storage
        run: |
          sudo mkdir -p /mnt/android-sdk /mnt/android-avd
          sudo chown -R $(whoami):$(whoami) /mnt/android-sdk /mnt/android-avd
          chmod -R 755 /mnt/android-sdk /mnt/android-avd
          echo "โ /mnt ready"

      - name: Set Environment
        run: |
          cat >> $GITHUB_ENV << 'EOF'
          ANDROID_SDK_ROOT=/mnt/android-sdk
          ANDROID_HOME=/mnt/android-sdk
          ANDROID_AVD_HOME=/mnt/android-avd
          PATH=/mnt/android-sdk/cmdline-tools/latest/bin:/mnt/android-sdk/emulator:/mnt/android-sdk/platform-tools:/usr/bin:/bin
          LD_LIBRARY_PATH=/mnt/android-sdk/emulator/lib64:$LD_LIBRARY_PATH
          LIBGL_ALWAYS_INDIRECT=1
          EOF
          echo "โ Environment set"

      - name: Install Android SDK
        run: |
          echo "๐ฅ Downloading SDK..."
          cd /mnt/android-sdk
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          mkdir -p temp_extract
          cd temp_extract
          unzip -q ../commandlinetools-linux-11076708_latest.zip
          cd /mnt/android-sdk
          mkdir -p cmdline-tools/latest
          mv temp_extract/cmdline-tools/* cmdline-tools/latest/
          rm -rf temp_extract
          rm commandlinetools-linux-11076708_latest.zip
          echo "โ SDK tools installed"

      - name: Accept Licenses
        run: |
          yes | /mnt/android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null 2>&1 || true
          echo "โ Licenses accepted"

      - name: Install Android 14 with Play Store
        run: |
          echo "๐ฅ Installing Android 14 with Play Store..."
          /mnt/android-sdk/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0" "emulator" "system-images;android-34;google_play;arm64-v8a"
          echo "โ Android 14 installed"

      - name: Create AVD with Play Store
        run: |
          echo "๐ง Creating AVD..."
          echo "no" | /mnt/android-sdk/cmdline-tools/latest/bin/avdmanager create avd --force --name "android14" --package "system-images;android-34;google_play;arm64-v8a" --device "pixel_7"
          AVD_INI="/mnt/android-avd/android14.avd/config.ini"
          sed -i '/^hw.ramSize=/d' "$AVD_INI"
          sed -i '/^disk.dataPartition.size=/d' "$AVD_INI"
          sed -i '/^hw.gpu/d' "$AVD_INI"
          sed -i '/^hw.audio/d' "$AVD_INI"
          cat >> "$AVD_INI" << 'EOF'
          hw.ramSize=12288
          disk.dataPartition.size=40G
          hw.gpu.enabled=yes
          hw.gpu.mode=swiftshader_indirect
          hw.keyboard=yes
          hw.mainKeys=no
          hw.audio=none
          EOF
          echo "โ AVD created"

      - name: Start Virtual Display
        run: |
          Xvfb :1 -screen 0 1920x1080x24 > /tmp/xvfb.log 2>&1 &
          sleep 3
          export DISPLAY=:1
          echo "DISPLAY=:1" >> $GITHUB_ENV
          echo "โ Display started"

      - name: Start Emulator
        run: |
          export DISPLAY=:1
          export ANDROID_SDK_ROOT=/mnt/android-sdk
          export ANDROID_AVD_HOME=/mnt/android-avd
          export LD_LIBRARY_PATH=/mnt/android-sdk/emulator/lib64:$LD_LIBRARY_PATH
          echo "๐ Starting emulator..."
          /mnt/android-sdk/emulator/emulator -avd android14 -no-snapshot-load -no-boot-anim -gpu swiftshader_indirect -no-audio -memory 12288 -partition-size 40960 -cores 4 > /tmp/emulator.log 2>&1 &
          EMULATOR_PID=$!
          echo "Emulator PID: $EMULATOR_PID"
          sleep 20
          if ! kill -0 $EMULATOR_PID 2>/dev/null; then
            echo "โ Emulator crashed"
            tail -50 /tmp/emulator.log
            exit 1
          fi
          echo "โ Emulator running"
          echo "โณ Waiting for device..."
          DEVICE_FOUND=0
          for i in {1..50}; do
            if /mnt/android-sdk/platform-tools/adb devices 2>/dev/null | grep -q "emulator"; then
              echo "โ Device found"
              DEVICE_FOUND=1
              break
            fi
            sleep 5
          done
          echo "โณ Waiting for boot..."
          BOOT_WAIT=0
          while [ $BOOT_WAIT -lt 180 ]; do
            BOOT_STATUS=$(/mnt/android-sdk/platform-tools/adb shell "getprop sys.boot_completed" 2>/dev/null || echo "0")
            if echo "$BOOT_STATUS" | grep -q "1"; then
              echo "โ Boot complete"
              break
            fi
            if [ $((BOOT_WAIT % 30)) -eq 0 ]; then
              echo "โณ Booting... $BOOT_WAIT seconds"
            fi
            sleep 5
            BOOT_WAIT=$((BOOT_WAIT + 5))
          done
          echo "โ Emulator ready"

      - name: Start VNC Server
        run: |
          export DISPLAY=:1
          echo "๐ Starting VNC..."
          x11vnc -display :1 -forever -nopw -rfbport 5900 -shared -bg -xkb
          sleep 2
          netstat -tuln | grep 5900 && echo "โ VNC on port 5900" || echo "โ๏ธ  VNC port issue"

      - name: Setup FRP Tunnel
        run: |
          cd /tmp
          echo "๐ Setting up FRP tunnel..."
          wget -q https://github.com/fatedier/frp/releases/download/v0.65.0/frp_0.65.0_linux_amd64.tar.gz
          tar -xzf frp_0.65.0_linux_amd64.tar.gz
          cat > frpc.toml << 'FRPEOF'
          serverAddr = "159.195.6.61"
          serverPort = 7000
          
          [[proxies]]
          name = "vnc-avd"
          type = "tcp"
          localIP = "127.0.0.1"
          localPort = 5900
          remotePort = 5900
          FRPEOF
          
          nohup ./frp_0.65.0_linux_amd64/frpc -c frpc.toml > /tmp/frpc.log 2>&1 &
          sleep 3
          ps aux | grep frpc | grep -v grep && echo "โ FRP tunnel active" || (echo "โ FRP failed"; cat /tmp/frpc.log)

      - name: Setup tmate SSH
        uses: mxschmitt/action-tmate@v3
        with:
          detached: true
          limit-access-to-actor: false
        timeout-minutes: 480

      - name: Connection Info
        run: |
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ         โ ANDROID 14 AVD READY (PLAY STORE)          โ"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          echo "๐ Browser Access (noVNC):"
          echo "   http://159.195.6.61"
          echo ""
          echo "๐ฑ Device:"
          echo "   OS: Android 14 (Google Play)"
          echo "   Model: Pixel 7"
          echo "   RAM: 12GB"
          echo "   Storage: 40GB"
          echo "   Architecture: ARM64"
          echo ""
          echo "๐ VNC Direct:"
          echo "   159.195.6.61:5900"
          echo ""
          echo "๐ SSH via tmate:"
          echo "   Check 'Setup tmate SSH' step output above for connection"
          echo ""
          echo "โฑ๏ธ  Duration: ${{ github.event.inputs.duration || '6' }} hours"
          echo ""

      - name: Keep Alive + Monitor
        run: |
          HOURS=${{ github.event.inputs.duration || '6' }}
          TOTAL_MINUTES=$((HOURS * 60))
          
          echo "โณ Keeping session alive for $HOURS hours..."
          echo ""
          
          for ((i=0; i<TOTAL_MINUTES; i++)); do
            sleep 60
            
            # Print status every 10 minutes
            if [ $((i % 10)) -eq 0 ]; then
              UPTIME=$((i / 60))
              STATE=$(/mnt/android-sdk/platform-tools/adb get-state 2>/dev/null || echo "offline")
              VNC_CHECK=$(netstat -tuln 2>/dev/null | grep 5900 || echo "")
              
              echo "[$UPTIME h / $HOURS h] Device: $STATE | VNC: $([ -n "$VNC_CHECK" ] && echo "โ" || echo "โ")"
            fi
            
            # Check if emulator crashed
            if ! /mnt/android-sdk/platform-tools/adb devices 2>/dev/null | grep -q "emulator"; then
              echo "โ๏ธ  Device disconnected at $((i / 60)) hours"
            fi
          done
          
          echo ""
          echo "โ Keep-alive completed"

      - name: Cleanup
        if: always()
        run: |
          echo "๐งน Cleaning up..."
          killall -9 emulator x11vnc Xvfb frpc tmate 2>/dev/null || true
          echo "โ Cleanup complete"
